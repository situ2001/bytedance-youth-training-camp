<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Document</title>
  </head>
  <body>
    <div id="app">{{title}}</div>
  </body>
  <script>
    const Vue = {
      // extensible
      createRenderer({ querySelector, insert }) {
        return {
          createApp(options) {
            return {
              mount(selector) {
                console.log("mounted");
                // 1. find parent element
                const parent = document.querySelector(selector);
                // 2. render the pages
                // 2.1 process template
                if (!options.render) {
                  options.render = this.compile(parent.innerHTML);
                }
                // setup & other options
                if (options.setup) {
                  this.setupState = options.setup();
                }
                if (options.data) {
                  this.data = options.data();
                }
                // app.xxx
                const proxy = new Proxy(this, {
                  get(target, key) {
                    // retrieve from setup, else from data
                    if (target.setupState && key in target.setupState) {
                      return target.setupState[key];
                    } else {
                      return target.data[key];
                    }
                  },
                  set(target, key, val) {
                    if (target.setupState && key in target.setupState) {
                      target.setupState[key] = val;
                    } else {
                      target.data[key] = val;
                    }
                  },
                });
                // 2.2 user-impl renderer
                this.update = function () {
                  const el = options.render.call(proxy);
                  // 3. append to parent
                  parent.innerHTML = "";
                  parent.appendChild(el);
                };
                this.update();
              },
              compile(template) {
                // return a render function
                // parse => AST => render
                return function render() {
                  const h3 = document.createElement("h3");
                  h3.textContent = this.title;
                  return h3;
                };
              },
            };
          },
        };
      },
      createApp(options) {
        // A web platform-specified renderer
        const renderer = Vue.createRenderer({
          querySelector(sel) {
            return document.querySelector(sel);
          },
          insert(el, parent) {
            parent.appendChild(el);
          },
        });
        return renderer.createApp(options);
      },
    };
  </script>
  <script>
    // intercept the visit to proxy object from user
    function reactive(obj) {
      return new Proxy(obj, {
        get(target, key) {
          console.log("get key:", key);
          return target[key];
        },
        set(target, key, val) {
          console.log("set key:", key);
          target[key] = val;
          // notify
          app.update();
        },
      });
    }
    // init Vue
    const app = Vue.createApp({
      setup() {
        const state = reactive({
          title: "world, Hello!",
        });
        setTimeout(() => {
          state.title = "Hello, world!";
        }, 2000);
        return state;
      },
    });
    app.mount("#app");
  </script>
</html>
